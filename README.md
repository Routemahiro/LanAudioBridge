# LanAudioBridge

![.NET 8](https://img.shields.io/badge/.NET-8.0-512BD4?logo=dotnet)
![Windows](https://img.shields.io/badge/platform-Windows%2010%2F11-0078D6?logo=windows)
![License](https://img.shields.io/badge/license-MIT-green)

> 同一LAN内のPC間で音声を低遅延で送受信する軽量ブリッジ

マイク入力をUDPで送信し、受信側の出力デバイスへリアルタイム再生。  
Opusエンコード対応で、品質と遅延のバランスを細かく調整できます。

<!-- スクリーンショットを追加したら以下のコメントを解除
![スクリーンショット](docs/screenshot.png)
-->

---

## 目次

- [クイックスタート](#クイックスタート)
- [特長](#特長)
- [導入手順（詳細）](#導入手順詳細)
- [構成図](#構成図)
- [使い方](#使い方)
- [設定](#設定)
  - [受信](#受信)
  - [送信](#送信)
  - [情報](#情報)
- [FAQ](#faq)
- [トラブルシューティング](#トラブルシューティング)
- [動作環境](#動作環境)
- [開発者向け](#開発者向け)
- [ライセンス](#ライセンス)
- [問い合わせ](#問い合わせ)

---

## クイックスタート

ビルド不要で今すぐ使いたい方向け：

1. **[Releases](../../releases/latest)** から最新版の `LanAudioBridge-vX.X.X.zip` をダウンロード
2. 解凍して `LanAudioBridge.exe` を送信側・受信側PCそれぞれで起動
3. 受信側に表示されるIPアドレスを送信側に入力して接続

> **Note**  
> 初回起動時にWindows Firewallの許可ダイアログが出たら「プライベートネットワーク」を許可してください。

---

## 特長

- **同一LAN特化** — ローカルネットワーク内の音声転送に最適化
- **低遅延/安定の調整** — ジッタバッファ・プリバッファで細かくチューニング
- **Opusエンコード** — 品質レベル選択可能（低/標準/高/超高）
- **音声処理** — 送受信両方でAGC・ノイズゲート・ゲイン調整
- **設定の保存/復元** — 次回起動時に前回設定を自動ロード
- **PCM直送モード** — デバッグ用途向けの非圧縮転送

---

## 導入手順（詳細）

ソースからビルドしたい方、または開発者向けの手順です。

### 1. 前提条件

- Windows 10 / 11 のPCを2台（送信側/受信側）
- 同一LAN（同じネットワーク）に接続
- [.NET 8 Runtime](https://dotnet.microsoft.com/download/dotnet/8.0) をインストール

### 2. VB-CABLEのインストール

仮想オーディオデバイスを使って他アプリに音声を流す場合に必要です。

1. [VB-CABLE公式サイト](https://vb-audio.com/Cable/) からダウンロード
2. **管理者として実行** でインストール
3. PCを **再起動**

### 3. リポジトリを取得

```powershell
git clone <このリポジトリのURL>
cd LanAudioBridge
```

### 4. ビルドと実行

```powershell
dotnet build
dotnet run --project .\LanAudioBridge\LanAudioBridge.csproj
```

### 5. 初回起動時の確認

- Windows Firewallで「プライベートネットワーク」を許可
- 受信側：出力デバイスに `CABLE Input` が表示されることを確認
- 送信側：入力デバイスに `CABLE Output` が表示されることを確認

---

## 構成図

```mermaid
flowchart LR
    A[送信側 マイク入力] -->|WASAPI/MME| B[前処理<br/>AGC/ゲート/ゲイン]
    B --> C[Opus/PCM エンコード]
    C -->|UDP| D[受信側 ジッタバッファ]
    D --> E[デコード/補間]
    E --> F[後処理<br/>AGC/ゲート/ゲイン]
    F --> G[出力デバイス]
```

---

## 使い方

1. **受信側** でアプリを起動し、表示されるIPアドレスを確認
2. **送信側** でアプリを起動し、受信側のIPアドレスを入力
3. 送信側で「送信開始」をクリック
4. 受信側で出力デバイスを選択し、音声が再生されることを確認

---

## 設定

### 受信

| 項目 | 説明 |
|------|------|
| 出力デバイス | 再生先（仮想ケーブル、物理スピーカー等） |
| ジッタバッファ | 低遅延↔安定性のバランス調整 |
| 音声処理 | AGC/ゲート/クリップのON/OFF |
| 出力ゲイン | 出力音量の補正 |
| 強制再生待ち | 少量入力時の待機時間 |
| チェック音 | ループバック確認用テストトーン |

### 送信

| 項目 | 説明 |
|------|------|
| 入力方式 | WASAPI（推奨）/ MME（互換性重視） |
| マイクデバイス | 送信元のマイクを選択 |
| 送信品質 | 低/標準/高/超高 |
| 送信方式 | Opus（推奨）/ PCM直送（テスト用） |
| 送信ゲイン | 入力音量の補正 |
| 送信開始閾値 | VAD（小さい声の扱い） |
| 音声処理 | AGC/ゲート/クリップのON/OFF |

### 情報

| 項目 | 説明 |
|------|------|
| 音量（Peak/RMS） | 入力レベルのリアルタイム表示 |
| 出力後レベル | 処理後の出力レベル |
| パケット統計 | Loss/Jitter/Delay |
| ガイド/警告 | 設定に関するヒント |

---

## FAQ

**Q. 送信品質の違いは？**  
高/超高は帯域を使う分、音質が向上します。  
LAN内で帯域に余裕があるなら「超高」がおすすめです。

**Q. PCM直送(テスト)は何ですか？**  
Opusを使わず生PCMで送るデバッグモードです。  
帯域を多く消費するため、通常はOpus推奨です。

**Q. 入力方式（WASAPI/MME）の違いは？**  
WASAPIが推奨。低遅延で動作します。  
MMEは互換性重視で、一部環境で遅延が増える場合があります。

**Q. 音声処理(AGC/ゲート/クリップ)はONがいい？**  
基本はON推奨です。  
原音のまま送りたい場合のみOFFで試してください。

---

## トラブルシューティング

### 小さい声が拾われない

- **送信開始閾値（VAD）を下げる**: 目安は `-55 ~ -70 dBFS`
- **送信ゲインを上げる**: 入力音量を増幅

### 音が途切れる

- **ジッタバッファを上げる**: 「Stable」または「Ultra stable」に変更
- **Wi-Fi → 有線LAN**: 無線は不安定になりやすい

### 遅延が大きい

- **ジッタバッファを下げる**: 「Low latency」に変更
- **強制再生待ちを短く**: `0.5s〜1.0s` が目安

### 音が小さい

- **受信側の出力ゲインを上げる**
- **送信側の送信ゲインも併用**: 両方で調整するとバランスが取りやすい

### チェック音がFAILになる

- **出力デバイスの確認**: 正しいデバイスが選択されているか
- **仮想ケーブルの設定**: 出力先と入力先が正しく対応しているか確認

---

## 動作環境

| 項目 | 要件 |
|------|------|
| OS | Windows 10 / 11 |
| ランタイム | .NET 8 |
| ネットワーク | 同一LAN環境 |
| 推奨 | 有線LAN接続 |

### 必要なソフトウェア

- **VB-CABLE** (VB-Audio Virtual Cable)
  - ダウンロード: https://vb-audio.com/Cable/
  - インストールは管理者権限で実行し、完了後に再起動

---

## 開発者向け

### 使用技術

- .NET 8 / C#
- WPF (Windows Presentation Foundation)
- NAudio (オーディオ処理)
- Concentus (Opus エンコード/デコード)

### ビルド

```powershell
dotnet restore
dotnet build --configuration Release
```

### リリースビルド（単一ファイル）

```powershell
dotnet publish -c Release -r win-x64 --self-contained false -p:PublishSingleFile=true
```

---

## ライセンス

MIT License  
詳細は [LICENSE](LICENSE) を参照してください。

---

## 問い合わせ

- X (Twitter): [@route20191212](https://twitter.com/route20191212)
