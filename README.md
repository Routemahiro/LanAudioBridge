# LanAudioBridge

![.NET 8](https://img.shields.io/badge/.NET-8.0-512BD4?logo=dotnet)
![Windows](https://img.shields.io/badge/platform-Windows%2010%2F11-0078D6?logo=windows)
![License](https://img.shields.io/badge/license-MIT-green)

> 同一LAN内のPC間で音声を低遅延で送受信する軽量ブリッジ

マイク入力をUDPで送信し、受信側の出力デバイスへリアルタイム再生。  
Opusエンコード対応で、品質と遅延のバランスを細かく調整できます。

<!-- スクリーンショットを追加したら以下のコメントを解除
![スクリーンショット](docs/screenshot.png)
-->

---

## 目次

- [クイックスタート](#クイックスタート)
- [特長](#特長)
- [導入手順（詳細）](#導入手順詳細)
- [構成図](#構成図)
- [使い方](#使い方)
- [設定](#設定)
  - [受信](#受信)
  - [送信](#送信)
  - [動作](#動作)
  - [情報](#情報)
- [FAQ](#faq)
- [トラブルシューティング](#トラブルシューティング)
- [動作環境](#動作環境)
- [開発者向け](#開発者向け)
- [ライセンス](#ライセンス)
- [問い合わせ](#問い合わせ)

---

## クイックスタート

ビルド不要で今すぐ使いたい方向け：

1. **[Releases](../../releases/latest)** から最新版の `LanAudioBridge-vX.X.X.zip` をダウンロード
2. 解凍して `LanMicBridge.exe` を送信側・受信側PCそれぞれで起動
3. 受信側に表示されるIPアドレスを送信側に入力して「開始」

> **Note**  
> - [.NET 8 Desktop Runtime](https://dotnet.microsoft.com/download/dotnet/8.0) が必要です（未インストールの場合は起動時に案内が表示されます）
> - 初回起動時にWindows Firewallの許可ダイアログが出たら「プライベートネットワーク」を許可してください
> - 仮想オーディオデバイス（VB-CABLE等）を使う場合は別途インストールが必要です（[導入手順](#2-vb-cableのインストール)を参照）

---

## 特長

- **同一LAN特化** — ローカルネットワーク内の音声転送に最適化
- **低遅延/安定の調整** — ジッタバッファ・プリバッファで細かくチューニング
- **Opusエンコード** — 品質レベル選択可能（低/標準/高/超高）
- **音声処理** — 送受信両方でAGC・ノイズゲート・ゲイン調整
- **ダッシュボード型UI** — メイン画面で音量メーター・パケット統計・接続状態をリアルタイム表示
- **タスクトレイ常駐** — 最小化でトレイに格納、接続状態をツールチップ表示
- **バルーン通知** — トレイ格納中でも接続切断・エラー・再接続をバルーンで通知
- **自動接続** — 起動時に前回のモードで自動接続開始
- **Windows自動起動** — スタートアップ登録でPC起動時に自動起動、トレイ直行も可
- **同時起動防止** — 2回目の起動で既存ウィンドウを自動的に前面に表示
- **設定の保存/復元** — 次回起動時に前回設定を自動ロード
- **PCM直送モード** — デバッグ用途向けの非圧縮転送

---

## 導入手順（詳細）

ソースからビルドしたい方、または開発者向けの手順です。

### 1. 前提条件

- Windows 10 / 11 のPCを2台（送信側/受信側）
- 同一LAN（同じネットワーク）に接続
- [.NET 8 Runtime](https://dotnet.microsoft.com/download/dotnet/8.0) をインストール

### 2. VB-CABLEのインストール

仮想オーディオデバイスを使って他アプリに音声を流す場合に必要です。

1. [VB-CABLE公式サイト](https://vb-audio.com/Cable/) からダウンロード
2. **管理者として実行** でインストール
3. PCを **再起動**

### 3. リポジトリを取得

```powershell
git clone https://github.com/Routemahiro/LanAudioBridge.git
cd LanAudioBridge
```

> リポジトリURLは画面右上の「Code」ボタンからもコピーできます。

### 4. ビルドと実行

```powershell
dotnet build
dotnet run --project .\LanMicBridge\LanMicBridge.csproj
```

### 5. 初回起動時の確認

- Windows Firewallで「プライベートネットワーク」を許可
- 受信側：出力デバイスに `CABLE Input` が表示されることを確認
- 送信側：入力デバイスにマイクデバイスが表示されることを確認

---

## 構成図

```mermaid
flowchart LR
    A[送信側 マイク入力] -->|WASAPI/MME| B[前処理<br/>AGC/ゲート/ゲイン]
    B --> C[Opus/PCM エンコード]
    C -->|UDP| D[受信側 ジッタバッファ]
    D --> E[デコード/補間]
    E --> F[後処理<br/>AGC/ゲート/ゲイン]
    F --> G[出力デバイス]
```

---

## 使い方

アプリは **受信モード** と **送信モード** をメイン画面上部のボタンで切り替えて使います。

### 受信側

1. アプリを起動すると受信モードで待受が自動開始
2. メイン画面に表示される **IPアドレス** を送信側に伝える
3. 受信中は音量メーター（Peak/RMS）とパケット統計がリアルタイム表示
4. 接続状態インジケーター: 🟢受信中 / 🟡再接続中 / 🔴エラー / ⚪接続待ち

### 送信側

1. モード切替で「送信」を選択
2. 受信側のIPアドレスを入力し「開始」をクリック
3. 送信中は入力レベルメーター（Peak/RMS）がリアルタイム表示
4. 「停止」で送信を終了

### タスクトレイ

- **最小化** するとタスクバーから消え、通知領域（トレイ）にアイコンが格納されます
- **トレイアイコンをダブルクリック** でウィンドウを復帰
- **右クリックメニュー**: 「ウィンドウを表示」「設定」「終了」
- ツールチップに現在の接続状態を表示
- **バルーン通知**: トレイ格納中でも以下の状態変化をバルーンで通知します
  - 接続が切断されたとき（再接続を試行中）
  - エラーが発生したとき（原因と対処法をセットで表示）
  - 再接続に成功したとき

### 全自動運用（セットアップしたら放置）

設定 → 動作タブで以下を有効にすると、完全自動で動作します：

1. **起動時に自動接続する** — 前回のモードで自動的に接続開始
2. **起動時にタスクトレイに格納する** — ウィンドウを表示せずトレイ直行
3. **Windows起動時に自動起動する** — PC起動時にスタートアップから自動起動

→ PC起動だけで自動的に接続され、トレイに常駐する状態になります。

---

## 設定

メイン画面の「⚙ 詳細設定」ボタンから設定ウィンドウを開きます。  
設定ウィンドウは **受信 / 送信 / 情報 / 動作** の4タブ構成です。

### 受信

| 項目 | 説明 |
|------|------|
| 出力デバイス | 再生先（仮想ケーブル、物理スピーカー等） |
| ジッタバッファ | 低遅延↔安定性のバランス調整 |
| 音声処理 | AGC/ゲート/クリップのON/OFF（**通常はOFF推奨**） |
| 出力ゲイン | 出力音量の補正（100% = 1.0倍） |
| 強制再生待ち | 少量入力時の待機時間 |
| チェック音 | ループバック確認用テストトーン |

### 送信

| 項目 | 説明 |
|------|------|
| 入力方式 | WASAPI（推奨）/ MME（互換性重視） |
| マイクデバイス | 送信元のマイクを選択 |
| 送信品質 | 低/標準/高/超高 |
| 送信方式 | Opus（推奨）/ PCM直送（テスト用） |
| 送信ゲイン | 入力音量の補正（100% = 1.0倍） |
| 送信開始閾値 | VAD（小さい声の扱い） |
| 音声処理 | AGC/ゲート/クリップのON/OFF |

### 動作

| 項目 | 説明 |
|------|------|
| 起動時に自動接続する | 前回のモードで自動的に接続開始 |
| 起動時にタスクトレイに格納する | ウィンドウを表示せずトレイ直行 |
| Windows起動時に自動起動する | スタートアップフォルダにショートカットを登録 |

### 情報

トラブルシューティングガイドを表示します。  
音が聞こえない/途切れる場合の確認手順を参照できます。

---

## FAQ

**Q. 送信品質の違いは？**  
高/超高は帯域を使う分、音質が向上します。  
LAN内で帯域に余裕があるなら「超高」がおすすめです。

**Q. PCM直送(テスト)は何ですか？**  
Opusを使わず生PCMで送るデバッグモードです。  
帯域を多く消費するため、通常はOpus推奨です。

**Q. 入力方式（WASAPI/MME）の違いは？**  
WASAPIが推奨。低遅延で動作します。  
MMEは互換性重視で、一部環境で遅延が増える場合があります。

**Q. 受信側の音声処理(AGC/ゲート/クリップ)はONがいい？**  
受信側は **OFF推奨** です。ポンピング等の副作用が出やすいため、基本はOFFで使ってください。  
送信側の音声処理は通常ONで問題ありません。

**Q. アプリを2回起動してしまった場合は？**  
同時起動防止機能により、既に起動中のウィンドウが自動的に前面に表示されます。  
タスクトレイに格納中でも正しく復帰します。

**Q. PC起動時に自動接続したい**  
設定 → 動作タブで「起動時に自動接続する」「Windows起動時に自動起動する」をONにしてください。  
「起動時にタスクトレイに格納する」も併用すると、完全にバックグラウンドで動作します。

---

## トラブルシューティング

### 小さい声が拾われない

- **送信開始閾値（VAD）を下げる**: 目安は `-55 ~ -70 dBFS`
- **送信ゲインを上げる**: 入力音量を増幅

### 音が途切れる

- **ジッタバッファを上げる**: 「Stable」または「Ultra stable」に変更
- **Wi-Fi → 有線LAN**: 無線は不安定になりやすい

### 遅延が大きい

- **ジッタバッファを下げる**: 「Low latency」に変更
- **強制再生待ちを短く**: `0.5s〜1.0s` が目安

### 音が小さい

- **受信側の出力ゲインを上げる**
- **送信側の送信ゲインも併用**: 両方で調整するとバランスが取りやすい

### チェック音がFAILになる

- **出力デバイスの確認**: 正しいデバイスが選択されているか
- **仮想ケーブルの設定**: 出力先と入力先が正しく対応しているか確認

### 音量が0付近で動かない

- 送信側が停止していないか確認
- 送信側のIPアドレスが正しいか確認
- Firewallがポート48750を許可しているか確認

### 音量が動くのに音が聞こえない

- 入力先アプリのマイク入力を「CABLE Output」に設定
- 出力デバイスが「CABLE Input」になっているか確認

---

## 動作環境

| 項目 | 要件 |
|------|------|
| OS | Windows 10 / 11 |
| ランタイム | .NET 8 |
| ネットワーク | 同一LAN環境 |
| 推奨 | 有線LAN接続 |

### 必要なソフトウェア

- **VB-CABLE** (VB-Audio Virtual Cable)
  - ダウンロード: https://vb-audio.com/Cable/
  - インストールは管理者権限で実行し、完了後に再起動

---

## 開発者向け

### 使用技術

- .NET 8 / C#
- Windows Forms (WinForms)
- NAudio (オーディオ処理)
- Concentus (Opus エンコード/デコード)

### プロジェクト構成

| ファイル | 役割 |
|---|---|
| `Program.cs` | エントリポイント（同時起動防止 + EventWaitHandle） |
| `Form1.cs` | メインフォーム（イベントハブ + フィールド定義 + トレイ管理） |
| `Form1.Ui.cs` | UI構築・表示更新・トレイアイコン・スタートアップ管理 |
| `Form1.Settings.cs` | 設定永続化・設定ウィンドウ・折りたたみ状態永続化 |
| `Form1.Receiver.cs` | 受信UIロジック（Engine呼び出し） |
| `Form1.Sender.cs` | 送信UIロジック（Engine呼び出し + インジケーター連動） |
| `Engine/ReceiverEngine.cs` | 受信コアロジック |
| `Engine/SenderEngine.cs` | 送信コアロジック |
| `Engine/EngineTypes.cs` | Engine共通型 |
| `Audio/AudioProcessor.cs` | 音声処理 |
| `AppSettings.cs` | 設定モデル（JSON永続化） |
| `SettingsForm.cs` | 設定ウィンドウ（タブ4つ: 受信/送信/情報/動作） |
| `UiTheme.cs` | UIテーマ一元管理（色/フォント/余白/ヘルパー） |
| `RoundedButton.cs` | 角丸ボタン カスタムコントロール |

### ビルド

```powershell
dotnet restore
dotnet build --configuration Release
```

### リリースビルド（単一ファイル）

```powershell
dotnet publish -c Release -r win-x64 --self-contained false -p:PublishSingleFile=true
```

### LAN共有フォルダで配布/実行（publish出力をリポジトリ内に作る）

ビルド環境（SDKあり）で以下を実行して、リポジトリ直下の `publish/` に成果物を出力します。

```powershell
.\publish.ps1 -Runtime win-x64
```

自己完結（Runtime不要）にしたい場合：

```powershell
.\publish.ps1 -Runtime win-x64 -SelfContained
```

単一ファイルにしたい場合（任意）：

```powershell
.\publish.ps1 -Runtime win-x64 -SingleFile
```

出力先の例：

- `.\publish\LanMicBridge\win-x64\framework-dependent\`
- `.\publish\LanMicBridge\win-x64\self-contained\`

LAN共有で使う場合は、この `publish/` 配下（またはそのフォルダだけ）を共有して、各PCで `LanMicBridge.exe` を実行してください。

---

## ライセンス

MIT License  
詳細は [LICENSE](LICENSE) を参照してください。

---

## 問い合わせ

- バグ報告・機能要望: [GitHub Issues](../../issues)
- X (Twitter): [@route20191212](https://twitter.com/route20191212)
